{% extends "base.html" %}

{% block title %}My Missions{% endblock %}

{% block content %}
<style>
    .pokemon-to-catch {
        margin: 15px 0;
        padding: 10px;
        background-color: rgba(255, 255, 255, 0.1);
        border-radius: 8px;
    }
    
    .pokemon-label {
        font-weight: bold;
        margin-bottom: 8px;
        color: var(--pokemon-blue);
    }
    
    .pokemon-images {
        display: flex;
        flex-wrap: wrap;
        gap: 15px;
        justify-content: center;
    }
    
    .pokemon-item {
        display: flex;
        align-items: center;
        justify-content: center;
    }
    
    .pokemon-var {
        width: 48px;
        height: 48px;
        object-fit: contain;
        transition: transform 0.2s ease;
    }
    
    .pokemon-var:hover {
        transform: scale(1.2);
    }
</style>

<div class="container">
    <h1 class="text-center font-xxl">My Missions</h1>
    
    <div class="card">
        <h2 class="text-center font-xl">Summary</h2>
        <div class="flex flex-center flex-gap-lg">
            <div class="stat-item text-center">
                <div class="stat-value font-xl">{{ stats.total_attempts }}</div>
                <div class="stat-label" style="padding-left: 5px;">Missions Attempted</div>
            </div>
            <div class="stat-item text-center">
                <div class="stat-value font-xl">{{ stats.total_solved }}</div>
                <div class="stat-label" style="padding-left: 5px;">Missions Completed</div>
            </div>
        </div>
    </div>
    
    {% if attempts %}
    <div class="quiz-list">
        {% for attempt in attempts %}
        <div class="card">
            <h3 class="font-lg">{{ attempt.title }}</h3>
            
            {% if attempt.exists and 'quiz_data' in attempt %}
                {% if 'pokemon_vars' in attempt.quiz_data and attempt.quiz_data.pokemon_vars|length > 0 %}
                <div class="pokemon-to-catch">
                    <p class="pokemon-label">Pokemon to catch:</p>
                    <div class="pokemon-images">
                        {% for var, img_path in attempt.quiz_data.pokemon_vars.items() %}
                            <div class="pokemon-item">
                                <img src="{{ url_for('static', filename='images/' + img_path) }}" class="pokemon-var" alt="{{ var }}">
                            </div>
                        {% endfor %}
                    </div>
                </div>
                {% endif %}
            {% endif %}
            
            <p class="played-on">Played on: 
                {% set timestamp_parts = attempt.timestamp.split('T') %}
                {% if timestamp_parts|length > 1 %}
                    {% set date_part = timestamp_parts[0].split('-') %}
                    {% set time_part = timestamp_parts[1].split(':') %}
                    {% set year = date_part[0]|int %}
                    {% set month = date_part[1]|int %}
                    {% set day = date_part[2]|int %}
                    {% set hour = time_part[0]|int %}
                    {% set minute = time_part[1]|int %}
                    
                    {% set months = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'] %}
                    {% set month_name = months[month-1] %}
                    
                    {% set formatted_time = '%02d'|format(hour) + ':' + '%02d'|format(minute) %}
                    
                    {# Get current date for comparison #}
                    {% set now = now|default(None) %}
                    {% if now is none %}
                        {% set now = {'year': 2025, 'month': 2, 'day': 26} %}
                    {% endif %}
                    
                    {# Check if date is today or yesterday #}
                    {% if year == now.year and month == now.month and day == now.day %}
                        Today at {{ formatted_time }}
                    {% elif year == now.year and month == now.month and day == now.day - 1 %}
                        Yesterday at {{ formatted_time }}
                    {% elif year == now.year %}
                        {{ day }} {{ month_name }} at {{ formatted_time }}
                    {% else %}
                        {{ day }} {{ month_name }} {{ year }} at {{ formatted_time }}
                    {% endif %}
                {% else %}
                    {{ attempt.timestamp }}
                {% endif %}
            </p>
            
            {% if attempt.solved %}
            <div class="completion-badge">
                <img src="{{ url_for('static', filename='images/pokeball-1.gif') }}" alt="Pokeball" width="24" height="24">
                <span class="font-bold" style="color: var(--pokemon-green);">Completed!</span>
            </div>
            {% endif %}
            
            {% if not attempt.exists %}
            <p class="font-bold" style="color: var(--pokemon-red);">This mission is no longer available.</p>
            {% endif %}
            
            <div class="quiz-buttons">
                {% if attempt.exists %}
                <div class="button-wrapper">
                    <a href="{{ url_for('quiz', quiz_id=attempt.id) }}" class="button-base button-blue">Play Again</a>
                </div>
                {% else %}
                <div class="button-wrapper">
                    <button disabled class="button-base button-dark">Not Available</button>
                </div>
                {% endif %}
                
                <form action="{{ url_for('forget_quiz') }}" method="post" class="remove-form">
                    <input type="hidden" name="timestamp" value="{{ attempt.timestamp }}">
                    <button type="submit" class="button-base button-red">Remove</button>
                </form>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <div class="card text-center">
        <div class="empty-state">
            <img src="{{ url_for('static', filename='images/psyduck_wonder.gif') }}" alt="No missions yet" width="120" height="120">
            <p class="font-md">You haven't attempted any missions yet.</p>
            <a href="{{ url_for('new_exercise') }}" class="button-base button-blue">Try a New Mission</a>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %} 