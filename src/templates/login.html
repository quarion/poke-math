{% extends "base.html" %}
{% block title %}Login - Pokemath!{% endblock %}

{% block content %}
<div class="login-container">
  <div class="login-card">
    <h2>Welcome to Pokemath!</h2>
    <p class="login-description">Train your brain with fun Pokemon-themed math exercises and become a true Math Pokemon Master!</p>
    
    <!-- Error message container -->
    <div id="error-message" class="error-message" style="display: none;"></div>
    
    <div class="login-options">
      <div class="login-option">
        <h3>Sign in with Google</h3>
        <p>Save your progress and access it from any device.</p>
        <button id="google-signin" class="button-base button-blue">
          <img src="{{ url_for('static', filename='images/google-icon.svg') }}" alt="Google" class="google-icon">
          Sign in with Google
        </button>
      </div>
      
      <div class="login-divider">
        <span>or</span>
      </div>
      
      <div class="login-option">
        <h3>Continue as Guest</h3>
        <p class="guest-warning">Your progress will only be saved on this device and may be lost if you clear your browser data.</p>
        <a href="{{ url_for('guest_login') }}" class="button-base button-green">Continue as Guest</a>
      </div>
    </div>
  </div>
</div>

<!-- Firebase Authentication UI -->
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-auth-compat.js"></script>

<script>
  // Function to display error messages
  function showError(message) {
    const errorElement = document.getElementById('error-message');
    errorElement.textContent = message;
    errorElement.style.display = 'block';
    console.error(message);
  }

  // Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyClyfiMLAAF2VJ4Zm0SXLy5vGmJT7vG4Uc",
    authDomain: "pokemath-451818.firebaseapp.com",
    projectId: "pokemath-451818",
    storageBucket: "pokemath-451818.firebasestorage.app",
    messagingSenderId: "991216996410",
    appId: "1:991216996410:web:5b132b357db762dec3e503"
  };

  // Initialize Firebase
  try {
    firebase.initializeApp(firebaseConfig);
    console.log("Firebase initialized successfully");
  } catch (error) {
    showError("Firebase initialization error: " + error.message);
  }
  
  // Set up Google sign-in
  document.getElementById('google-signin').addEventListener('click', function() {
    try {
      const provider = new firebase.auth.GoogleAuthProvider();
      console.log("Starting Google sign-in process");
      
      firebase.auth().signInWithPopup(provider)
        .then((result) => {
          console.log("Google sign-in successful");
          
          // Get the Google ID token using the recommended method
          return firebase.auth().currentUser.getIdToken(/* forceRefresh */ true);
        })
        .then((idToken) => {
          console.log("ID token obtained");
          
          // Send the token to the server
          console.log("Sending token to server...");
          return fetch('{{ url_for("auth_callback") }}', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': '{{ csrf_token() }}'
            },
            body: JSON.stringify({ id_token: idToken })
          });
        })
        .then(response => {
          console.log("Server response received:", response.status);
          if (!response.ok) {
            throw new Error(`Server returned ${response.status}: ${response.statusText}`);
          }
          return response.json();
        })
        .then(data => {
          console.log("Response data:", data);
          if (data.success) {
            // Redirect to name input or home page
            console.log("Authentication successful, redirecting to:", data.redirect);
            window.location.href = data.redirect;
          } else {
            showError('Authentication failed: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error during authentication process:', error);
          showError('Authentication failed: ' + error.message);
        });
    } catch (error) {
      console.error('Error initiating Google sign-in:', error);
      showError('Failed to start Google sign-in: ' + error.message);
    }
  });
</script>
{% endblock %} 