{% extends "base.html" %}
{% block content %}
  <!-- Debug info (hidden) -->
  <div style="display: none">
    <p>Quiz: {{ quiz }}</p>
    <p>Pokemon vars: {{ pokemon_vars }}</p>
  </div>

  <h2>{{ quiz.title }}</h2>
  <p>{{ quiz.description }}</p>

  <form id="quizForm" method="POST">
    {# Process each equation and replace placeholders with images #}
    {% for equation in quiz.equations %}
      {% set ns = namespace(equation=equation) %}
      {% for pokemon_name, image_file in pokemon_vars.items() %}
        {% set placeholder = "{" ~ pokemon_name ~ "}" %}
        {% if placeholder in ns.equation %}
          {% set ns.equation = ns.equation | replace(
            placeholder,
            '<img src="/static/images/' ~ image_file ~ 
            '" class="pokemon-var" alt="' ~ pokemon_name ~ 
            '" style="height:30px; display:inline-block;">'
          ) %}
        {% endif %}
      {% endfor %}
      <div class="equation">
        <div style="font-size:1.2em; margin:10px 0;">{{ ns.equation | safe }}</div>
      </div>
    {% endfor %}

    {# Dedicated Answers Section using keys from quiz.answer #}
    <h3>Your Answers</h3>
    <div class="answers-section" style="margin-bottom:20px;">
      {% for unknown, correct_value in quiz.answer.items() %}
        <div class="answer-group">
          <div class="answer-input">
            <label for="{{ unknown }}">
              <img src="/static/images/{{ pokemon_vars[unknown] }}" class="pokemon-var" alt="{{ unknown }}" style="height:30px; display:inline-block;">
            </label>
            <input type="number" 
                   name="{{ unknown }}" 
                   id="{{ unknown }}" 
                   value="{{ user_answers[unknown] if unknown in user_answers else '' }}"
                   required 
                   style="width:60px; margin:0 5px;">
          </div>
          <div class="celebration-gif" id="celebration-{{ unknown }}" style="display: none;">
            <img src="/static/images/pokeball-1.gif" alt="Celebration pokeball" style="height:30px;">
          </div>
        </div>
      {% endfor %}
    </div>

    <div class="quiz-controls">
      <a href="{{ url_for('index') }}" class="button-base button-dark">Back to List</a>
      <button type="submit" class="button-base button-blue">Check Answers</button>
      {% if quiz.next_quiz_id %}
        <a href="{{ url_for('quiz', quiz_id=quiz.next_quiz_id) }}" class="button-base button-blue" style="display: none;" id="nextQuiz">Next Quiz â†’</a>
      {% endif %}
    </div>
  </form>

  <div id="quiz-results" style="margin-top:20px;"></div>

  <script>
    document.getElementById('quizForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        const resultsDiv = document.getElementById('quiz-results');
        const nextButton = document.getElementById('nextQuiz');
        const submitButton = document.getElementById('submitBtn');
        
        // Hide all celebration gifs first
        document.querySelectorAll('.celebration-gif').forEach(gif => {
          gif.style.display = 'none';
        });
        
        // Show pokeballs for correct answers
        Object.entries(data.correct_answers).forEach(([pokemon, isCorrect]) => {
          const celebrationGif = document.getElementById(`celebration-${pokemon}`);
          if (celebrationGif) {
            celebrationGif.style.display = isCorrect ? 'block' : 'none';
          }
        });
        
        if (data.correct) {
          resultsDiv.innerHTML = `
            <div class="result-correct">
              <h3>All Correct!</h3>
            </div>
          `;
          submitButton.style.display = 'none';
          if (nextButton) nextButton.style.display = 'inline-block';
        } else {
          resultsDiv.innerHTML = `
            <div class="result-incorrect">
              <h3>Keep trying! Some answers are correct!</h3>
            </div>
          `;
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
  </script>
{% endblock %}
