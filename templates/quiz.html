{% extends "base.html" %}
{% block content %}
  <!-- Debug info (hidden) -->
  <div class="debug-info">
    <p>Quiz: {{ quiz }}</p>
    <p>Pokemon vars: {{ pokemon_vars }}</p>
  </div>

  <article class="quiz-content">
    <h2>{{ quiz.title }}</h2>
    <p>{{ quiz.description }}</p>

    <form id="quizForm" method="POST">
      <div class="equations-section">
        {% for equation in quiz.equations %}
          {% set ns = namespace(equation=equation) %}
          {% for pokemon_name, image_file in pokemon_vars.items() %}
            {% set placeholder = "{" ~ pokemon_name ~ "}" %}
            {% if placeholder in ns.equation %}
              {% set ns.equation = ns.equation | replace(
                placeholder,
                '<img src="/static/images/' ~ image_file ~ 
                '" class="pokemon-var" alt="' ~ pokemon_name ~ '">'
              ) %}
            {% endif %}
          {% endfor %}
          <div class="equation">
            <div class="equation-content">{{ ns.equation | safe }}</div>
          </div>
        {% endfor %}
      </div>

      <div class="answers-section">
        <h3>Your Answers</h3>
        {% for unknown, correct_value in quiz.answer.items() %}
          <div class="answer-group">
            <div class="answer-input">
              <label for="{{ unknown }}">
                <img src="/static/images/{{ pokemon_vars[unknown] }}" class="pokemon-var" alt="{{ unknown }}">
              </label>
              <input type="number" 
                     name="{{ unknown }}" 
                     id="{{ unknown }}" 
                     value="{{ user_answers[unknown] if unknown in user_answers else '' }}"
                     required>
            </div>
            <div class="celebration-gif" id="celebration-{{ unknown }}">
              <img src="/static/images/pokeball-1.gif" alt="Celebration pokeball">
            </div>
          </div>
        {% endfor %}
      </div>

      <div class="quiz-controls">
        <a href="{{ url_for('index') }}" class="button-base button-dark">Back to List</a>
        <button type="submit" id="submitBtn" class="button-base button-blue">Check Answers</button>
        {% if quiz.next_quiz_id %}
          <a href="{{ url_for('quiz', quiz_id=quiz.next_quiz_id) }}" class="button-base button-blue" id="nextQuiz">Next Question â†’</a>
        {% endif %}
      </div>
    </form>

    <div id="quiz-results"></div>
  </article>

  <script>
    document.getElementById('quizForm').addEventListener('submit', function(e) {
      e.preventDefault();
      
      const formData = new FormData(this);
      fetch(window.location.pathname, {
        method: 'POST',
        headers: {
          'X-Requested-With': 'XMLHttpRequest'
        },
        body: formData
      })
      .then(response => response.json())
      .then(data => {
        const resultsDiv = document.getElementById('quiz-results');
        const nextButton = document.getElementById('nextQuiz');
        const submitButton = document.getElementById('submitBtn');
        
        // Hide all celebration gifs first
        document.querySelectorAll('.celebration-gif').forEach(gif => {
          gif.style.display = 'none';
        });
        
        // Show pokeballs for correct answers
        Object.entries(data.correct_answers).forEach(([pokemon, isCorrect]) => {
          const celebrationGif = document.getElementById(`celebration-${pokemon}`);
          if (celebrationGif) {
            celebrationGif.style.display = isCorrect ? 'block' : 'none';
          }
        });
        
        if (data.correct) {
          resultsDiv.innerHTML = `
            <div class="result-correct">
              <h3>All Correct!</h3>
              <p>Great job! You can move on to the next question.</p>
            </div>
          `;
          submitButton.style.display = 'none';
          if (nextButton) {
            nextButton.style.display = 'inline-block';
            nextButton.focus();
          }
        } else {
          resultsDiv.innerHTML = `
            <div class="result-incorrect">
              <h3>Keep trying! Some answers are correct!</h3>
            </div>
          `;
          submitButton.style.display = 'inline-block';
          if (nextButton) {
            nextButton.style.display = 'none';
          }
        }
      })
      .catch(error => {
        console.error('Error:', error);
      });
    });
  </script>
{% endblock %}
